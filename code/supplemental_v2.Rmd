---
title: "Supplementary figures"
output:
  word_document:
    reference_docx: "../text/word-style-reference-ttmanu-iscb-iscience-v2.docx"
always_allow_html: TRUE
editor_options:
  chunk_output_type: console
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, dpi=600, warning = FALSE, message = FALSE)
suppressPackageStartupMessages(c(
  library(tidyverse),
  library(data.table),
  library(plot3D),
  library(flextable),
  library(knitr),
  library(kableExtra),
  library(xlsx),
  library(patchwork)
))
```

\pagenumbering{gobble} 

```{r supplementary-figure-s1, fig.width = 9, fig.height = 10}
umap_cancertype <- fread("../data/umap_3d_coors.tsv") ## load data
load("../data/kelly.colours.rda")
cluster.colours <- c(kelly.colours[c(3:12)]) ## Color scheme
names(cluster.colours) <- c(1:10) ## Assign cluster to color


cancer_type <- unique(umap_cancertype$project_code) ## Get cancer type in data set
cancer_type <- cancer_type[order(cancer_type)] ## Order alphabetically 



par(mfrow = c(6,4), mai = c(0.1, 0.1, 0.1, 0.1))
par(mar = c(0,0,0,0))
for(n in cancer_type[1:23]) {
with(umap_cancertype %>% 
       filter(project_code == n),
     scatter3D(plot_y, -plot_z, plot_x, 
                                bg = cluster.colours[as.character(clust_knn)], pch = 21, cex = 0.8, lwd = 0.2,
                                theta = 0, phi = 65, scale = F, axes = FALSE,
               xlim = c(-6, 4.5), zlim = c(-4.5, 4), ylim = c(-4, 5),
                                xlab = "", ylab = "UMAP 3", zlab = "UMAP 1",
                                colvar = NULL))
legend("bottom", inset = c(0), legend=n, bty = "n", horiz = T, cex = 1.2, adj = 0.25)
}
```

**Figure S1. Distribution of cancer type on UMAP clusters.** Each panel shows the identity of 
individual tumors by one of 23 cancer types projected onto the cluster UMAP identified 
in **Figure 1B of the main text**. The colors indicate the tumor's cluster identity.

\newpage

```{r supplementary-figure-s2-data-generation, fig.width = 9, fig.height = 10}
load("../data/ditto.colours.rda")

## Determining which cancer type has subtype information
cancer_w_subtypes <- list()
for(n in cancer_type) {
  spec_cancer <- umap_cancertype %>% 
    mutate(J_color = case_when(project_code == n ~ Subtype_Selected,
                               TRUE ~ "Other")) %>%
    filter(J_color != "Other")
  if(nrow(spec_cancer) == 0) {next
  }
  cancer_w_subtypes[[n]] <- n
}

cancer_w_subtypes <- names(cancer_w_subtypes)

par(mfrow = c(6,4), mai = c(0.1, 0.1, 0.1, 0.1))
par(mar = c(0,0,0,0))

for(n in cancer_w_subtypes[1:19]) {
  spec_cancer <- umap_cancertype %>% 
    mutate(J_color = case_when(project_code == n ~ Subtype_Selected,
                               TRUE ~ "Other")) %>%
    filter(J_color != "Other")
  if(nrow(spec_cancer) == 0) {next
    }
  subtypes <- unique(spec_cancer$J_color)
  J_colors <- c(ditto_colours[c(2:(length(subtypes) + 1))])#, 'grey')
  names(J_colors) <- subtypes

  with(spec_cancer,
     scatter3D(plot_y, -plot_z, plot_x, 
               bg = J_colors[J_color], pch = 21, cex = 0.8, lwd = 0.2,
               theta = 0, phi = 65, scale = F, axes = FALSE,
               xlim = c(-6, 4.5), zlim = c(-4.5, 4), ylim = c(-4, 5),
               xlab = "", ylab = "UMAP 3", zlab = "UMAP 1",
               colvar = NULL))
  legend("bottom", inset = c(0), legend=n, bty = "n", horiz = T, cex = 1.2, adj = 0.25)
  legend("top", inset = c(0), legend=names(J_colors[1:2]), col=J_colors[1:2], pch = 20, bty = "n", horiz = T, cex = 1)
  legend("top", inset = c(0.08), legend=names(J_colors[3:4]), col=J_colors[3:4], pch = 20, bty = "n", horiz = T, cex = 1)
  legend("top", inset = c(0.16), legend=names(J_colors[5:6]), col=J_colors[5:6], pch = 20, bty = "n", horiz = T, cex = 1)
}
```

**Figure S2. Histological subtypes.** Each panel shows the histological subtypes of one of the 23 
cancers projected onto the tumors of the UMAP from **Figure 1B of the main text**. The colors indicate the tumor's histological subtype identity.

\newpage

```{r supplementary-figure-s3-data-generation, eval = FALSE}
load("../data/gdc_tumor_coding_complete.Rdata")
load("../data/gene_data.Rda")

## Booleanize mutation count for each tumor sample
missense <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$missense) 
splice <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$splice)
frameshdel <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$frameshdel)
frameshins <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$frameshins)
utr3 <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$utr3)
utr5 <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$utr5)
nonstop <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$nonstop)
nonsense <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$nonsense)

gdc_mut_count_patient <- missense + splice + frameshdel + frameshins + utr3 + utr5 + nonstop + nonsense ## add up all the mutation count
rm(missense, splice, frameshdel, frameshins, utr3, utr5, nonstop, nonsense)
gc()
gdc_mut_count_patient[gdc_mut_count_patient > 0] <- 1 ## booleanize data, anything greater than 1 is equal to 1

## MMR genes
genes <- c("MSH2", "MSH6", "MLH1", "MLH3", "PMS1", "PMS2", "BRIP1", "RAD51", "CHEK2", "APC",
           "TET2", "TET3", "TERT", "TEP1", "DKC1")

selected_mut <- gene_data %>% dplyr::select(external_gene_name, ensembl_gene_id) %>% filter(external_gene_name %in% genes) ## getting ensembl_id for the mmr genes for filtering gdc data

selected_mut <- gdc_mut_count_patient %>% filter(rownames(.) %in% selected_mut$ensembl_gene_id) %>% ## filter by ensembl ids
  rownames_to_column(var = "ensembl_gene_id") %>% left_join(., selected_mut, by = "ensembl_gene_id") %>% ## replace ensembl ids with gene name 
  column_to_rownames(var = "external_gene_name") %>% dplyr::select(-ensembl_gene_id) %>%
  t() %>% as.data.frame() %>% rownames_to_column(var = "sample_id")  ## prep for left_join


selected_mut <- umap_cancertype %>% dplyr::select(sample_id, plot_x, plot_y, plot_z, clust_knn) %>% ## select relevant columns
  left_join(., selected_mut, by = "sample_id") %>%
  melt(data = ., id.vars = c("sample_id", "plot_x", "plot_y", "plot_z", "clust_knn")) %>%
  filter(value != 0)

save(selected_mut, file = "../data/selected_mut.Rda")
```

```{r supplementary-figure-s3, fig.width = 9, fig.height = 10}
load("../data/selected_mut.Rda")

genes <- c("MSH2", "MSH6", "MLH1", "MLH3", "PMS1", "PMS2", "BRIP1", "RAD51", "CHEK2", "APC", "TET2", "TET3", "TERT", "TEP1", "DKC1")

par(mfrow = c(6,4), mai = c(0.1, 0.1, 0.1, 0.1))
par(mar = c(0,0,0,0))
for(n in genes[1:15]) {
with(selected_mut %>% 
       filter(variable == n),
     scatter3D(plot_y, -plot_z, plot_x, 
                                bg = cluster.colours[as.character(clust_knn)], pch = 21, cex = 0.8, lwd = 0.2,
                                theta = 0, phi = 65, scale = F, axes = FALSE,
                                xlim = c(-6, 4.5), zlim = c(-4.5, 4), ylim = c(-4, 5),
                                xlab = "", ylab = "UMAP 3", zlab = "UMAP 1",
                                colvar = NULL))
title(xlab="UMAP 2", line=0)
legend("top", inset = c(0), legend=n, bty = "n", horiz = T, cex = 1.2)
}
```

**Figure S3. Distribution of mismatch repair genes on UMAP clusters.** Each panel shows one of 15 
genes involved in genome stability projected on the UMAP from **Figure 1B of the main text**. The colors indicate the tumor's cluster identity.

\newpage

```{r, supplemental-s4-data-generation, eval = FALSE}
load("../data/gdc_tumor_coding_complete.Rdata")
load("../data/gene_data.Rda")
umap_cancertype <- fread("../data/umap_3d_coors.tsv") ## load data

## Booleanize mutation count for each tumor sample
missense <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$missense) 
splice <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$splice)
frameshdel <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$frameshdel)
frameshins <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$frameshins)
utr3 <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$utr3)
utr5 <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$utr5)
nonstop <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$nonstop)
nonsense <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$nonsense)

gdc_mut_count_patient <- missense + splice + frameshdel + frameshins + utr3 + utr5 + nonstop + nonsense ## add up all the mutation count
rm(missense, splice, frameshdel, frameshins, utr3, utr5, nonstop, nonsense)
gc()
gdc_mut_count_patient[gdc_mut_count_patient > 0] <- 1 ## booleanize data, anything greater than 1 is equal to 1

## class 7 and 8 distinguishing genes
genes <- c("AKT2","BCL2","CTNNB1","ERBB2","KRAS","PIK3CA","CDKN2C","PTEN","RB1","SMARCA4","TP53","VHL")

selected_mut <- gene_data %>% dplyr::select(external_gene_name, ensembl_gene_id) %>% filter(external_gene_name %in% genes) ## getting ensembl_id for the genes for filtering gdc data

selected_mut <- gdc_mut_count_patient %>% filter(rownames(.) %in% selected_mut$ensembl_gene_id) %>% ## filter by ensembl ids
  rownames_to_column(var = "ensembl_gene_id") %>% left_join(., selected_mut, by = "ensembl_gene_id") %>% ## replace ensembl ids with gene name 
  column_to_rownames(var = "external_gene_name") %>% dplyr::select(-ensembl_gene_id) %>%
  t() %>% as.data.frame() %>% rownames_to_column(var = "sample_id")  ## prep for left_join


s5_data <- umap_cancertype %>% dplyr::select(sample_id, plot_x, plot_y, plot_z, clust_knn) %>% ## select relevant columns
  left_join(., selected_mut, by = "sample_id") %>%
  melt(data = ., id.vars = c("sample_id", "plot_x", "plot_y", "plot_z", "clust_knn")) %>%
  filter(value != 0)

save(s5_data, file = "../data/s5_data.Rda")
```

```{r supplemental-s4-plot, fig.width=9}
load("../data/s5_data.Rda")
genes <- c("AKT2","BCL2","CTNNB1","ERBB2","KRAS","PIK3CA","CDKN2C","PTEN","RB1","SMARCA4","TP53","VHL")

par(mfrow = c(2,3), mai = c(0.1, 0.1, 0.1, 0.1))
par(mar = c(2,2,0,0))
for(n in genes[1:6]) {
with(s5_data %>% 
       filter(variable == n),
     scatter3D(plot_y, -plot_z, plot_x, 
                                bg = cluster.colours[as.character(clust_knn)], pch = 21, cex = 0.8, lwd = 0.2,
                                theta = 0, phi = 65, scale = F,
               xlim = c(-6, 4.5), zlim = c(-4.5, 4), ylim = c(-4, 5),
                                xlab = "", ylab = "UMAP 3", zlab = "UMAP 1",
                                colvar = NULL))
title(xlab="UMAP 2", line=0)
legend("top", inset = c(0), legend=n, bty = "n", horiz = T, cex = 1.2)
}

par(mfrow = c(2,3), mai = c(0.1, 0.1, 0.1, 0.1))
par(mar = c(2,2,0,0))
for(n in genes[7:12]) {
with(s5_data %>% 
       filter(variable == n),
     scatter3D(plot_y, -plot_z, plot_x, 
                                bg = cluster.colours[as.character(clust_knn)], pch = 21, cex = 0.8, lwd = 0.2,
                                theta = 0, phi = 65, scale = F,
               xlim = c(-6, 4.5), zlim = c(-4.5, 4), ylim = c(-4, 5),
                                xlab = "", ylab = "UMAP 3", zlab = "UMAP 1",
                                colvar = NULL))
title(xlab="UMAP 2", line=0)
legend("top", inset = c(0), legend=n, bty = "n", horiz = T, cex = 1.2)
}

```

**Figure S4. Distribution of oncogenes/tumor suppressors on UMAP clusters.** Each panel shows shows one of the twelve oncogenes/tumor suppressors projected onto the tumors of the UMAP from **Figure 1B of the main text**. The colors indicate the tumor's cluster identity.

\newpage 


```{r supplemental-s5-plot-data, eval = FALSE}
## Calculate error distribution

## break error into bins for entropy calculation
## Set number of bins - 1024 bins
binsize <- 1024 - 2 ## -2 bins for the less than -3650 and greater than 3650 values
evaluebreak <- c(-1e10,seq(from = -3650.00, to = 3650.00, by = 3650*2/binsize), 1e10)
elabel <- list()
counter <- 2
for(i in evaluebreak[c(-1,-(length(evaluebreak)-1))]) {
  if(i == -1e10) {
    elabel[[counter]] <- paste0(i, "+")
  } else if(i == 1e10) {
    elabel[[counter]] <- paste0(i, "+")
  } else {
    elabel[[counter]] <- paste0(i, "-", round(evaluebreak[[counter+1]], digits = 2))
  }
  counter <- counter + 1
}
elabel <- as.character(elabel)
elabel[1] <- "-3650+"
elabel[1024] <- "3650+"

load("../data/deadpat_all.rda")
deadpat <- deadpat %>% rownames_to_column(var = "stanid")
## convert negative tdeath to 0
deadpat[which(deadpat$tevent < 0), "tevent"] <- 0
model <- c("knn", "icluster", "coca", "tis")
tdeath.error <- list() ## store error values
entropy <- list() 
for(n in model) {
  ## Load correct model
  if(n == "knn") {
    load("./survival/survmodel_effcl_knn_070121.stansave")
  } else if(n == "icluster") {
    load("./survival/survmodel_effcl_icluster_070121.stansave")
  } else if (n == "coca") {
    load("./survival/survmodel_effcl_coca_070121.stansave")
  } else if (n == "tis") {
    load("./survival/survmodel_effcl_tis_070121.stansave")
  } else {
    print("Model does not exist")
  }
  ## Extract tdeath for "adeath" indivduals
  tdeath <- samps %>% as.data.frame(.) %>% .[, grep(pattern = "tdeath", x = names(.))]
  names(tdeath) <- gsub("tdeath\\[(.*)\\]","\\1", names(tdeath)) ## update colname with stanid
  tdeath <- tdeath %>% gather(data = ., key = "stanid", value = "predicted") %>%
    left_join(x = ., y = deadpat[,c("stanid", "tevent", "eventtype")], by = "stanid") %>%
    dplyr::filter(eventtype == "adeath")
  ## Calculate error for each sample
  tdeath$error <- tdeath$predicted - tdeath$tevent
  tdeath.error[[n]] <- tdeath$error
  ## Split error data into bins and tally up 
  tdeath <- tdeath %>% mutate(ebin = cut(x = error,
                                         breaks = evaluebreak,
                                         right = T,
                                         labels = elabel))
  eprob <- as.data.frame(table(tdeath$ebin))
  eprob <- eprob %>% dplyr::filter(Freq > 0) %>%
    mutate(prob = Freq / nrow(tdeath))
  ## Entropy calculation
  entropy[[n]] <- round(-sum(eprob$prob*log(eprob$prob))/log(2), digit = 3)
}
knn <- data.frame(error = tdeath.error$knn,
                  model = "knn")
icluster <- data.frame(error = tdeath.error$icluster,
                       model = "icluster")
coca <- data.frame(error = tdeath.error$coca,
                   model = "coca")
tis <- data.frame(error = tdeath.error$tis,
                   model = "tis")
tdeath.error <- rbind(knn, icluster, coca, tis); rm(knn, icluster, coca, tis); gc()


## empirical cumulative distribution function
## Model selection
model <- c("knn", "icluster", "coca", "tis")

for(n in model) {
   ## Load correct model
  if(n == "knn") {
    load("./survival/survmodel_effcl_knn_070121.stansave")
  } else if(n == "icluster") {
    load("./survival/survmodel_effcl_icluster_070121.stansave")
  } else if (n == "coca") {
    load("./survival/survmodel_effcl_coca_070121.stansave")
  } else if (n == "tis") {
    load("./survival/survmodel_effcl_tis_070121.stansave")
  }
  else {
    print("Model does not exist")
  }
  dfs <- as.data.frame(samps) %>% 
    select(starts_with("tdeath[")) %>%
    stack(.) %>%
    'colnames<-' (c("tdeath", "stanid")) %>%
    .[sample(x = nrow(.), size = 1e5),]
  assign(x = n, value = dfs)
}

save(entropy, tdeath.error, knn, icluster, coca, tis, file = "../data/s5_plot.rda")
```

```{r supplemental-s5-plot, fig.width=9}
load("../data/s5_plot.rda")
load("../data/deadpat_all.rda")

s5.1 <- ggplot(knn) + stat_ecdf(aes(x=tdeath),color="#00BFC4", size = 1) + 
  stat_ecdf(aes(x=tevent),data=subset(deadpat,eventtype=="adeath"),col="#00BA38", size = 1) +
  stat_ecdf(aes(x=tdeath),data=icluster, color="#7CAE00", size = 1) + 
  stat_ecdf(aes(x=tdeath),data=coca, color="#F8766D", size = 1) + 
  stat_ecdf(aes(x=tdeath),data=tis, color="#F564E3", size = 1) + 
  coord_cartesian(xlim=c(0,365*5)) + 
  labs(x = "Survival Time (years past diagnosis)", y = "Fn(Survival Time)") +
  annotate(geom = "text", x = 250, y = 0.5, label = "Actual Death", color = "#00BA38", size = 3) +
  theme_minimal()

s5.2 <- ggplot(data = tdeath.error, aes(x = error, group = model, fill = model)) +
  geom_density(alpha = 0.5) +
  theme_minimal() +
  #scale_x_continuous(breaks=seq(-4000, 4000, by = 2000), limits = c(-3650,3650)) +
  labs(x = "Error (Predicted - Actual)", y = "Density")#, 
       #subtitle = paste0("Entropy - knn: ", entropy$knn, " ; icluster: ", entropy$icluster, "\ncoca: ", entropy$coca, " ; tis: ", entropy$tis))



layout = "
AABB
AABB
"

s5.1 + s5.2 + plot_annotation(tag_levels = "A") + plot_layout(design = layout)
```

**Figure S5. Performance comparison of different classification model - knn, COCA, iCluster, tissue-of-origin (tis).** A) Empirical cumulative distribution function comparing time of death prediction of all classification models with actual time of death (dark green). B) Error distribution plot of predicted and actual time of death.
