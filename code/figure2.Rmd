```{r oncoprint-top100-plus-panel-data-generation, eval = FALSE}
tumor_clusters <- fread("../data/umap_3d_coors.tsv") ## load in data
load("../data/gdc_reactome_path_analysis.Rda")

######################
## oncoprint top100 ##
######################
onco_color <- c("0" = "grey", "1" = "firebrick3")

top100path <- gdc_reactome_path_analysis %>% rowSums() %>% as.data.frame() %>% rownames_to_column(var = "path_name") %>% arrange(desc(.)) %>% .[1:100,] %>% .[, "path_name"] ## getting the top100 mutated pathways in class

top100path <- gdc_reactome_path_analysis[top100path, ] ## selecting the top 100 paths

top100path[top100path == "1"] <- "MUT" ## categorize boolean values
top100path[top100path == "0"] <- " "
col <- c("MUT" = "firebrick3")
heatmap_legend <- list(title = "", at = c("MUT"),
                       labels = c("Mutation"))
alter_fun = list(
    background = function(x, y, w, h) {
        grid.rect(x, y, w-unit(0.5, "mm"), h-unit(0.5, "mm"), 
            gp = gpar(fill = "#CCCCCC", col = NA))
    },
    # bug red
    MUT = function(x, y, w, h) {
        grid.rect(x, y, w-unit(0.5, "mm"), h-unit(0.5, "mm"), 
            gp = gpar(fill = col["MUT"], col = NA))
    })
  column_title <- "Top 100 Pathway PanCancer"
  onco_res <- oncoPrint(top100path,
    alter_fun = alter_fun, col = col,
    column_title = column_title, heatmap_legend_param = heatmap_legend,
    remove_empty_columns = F, remove_empty_rows = F, right_annotation = NULL,
    top_annotation = NULL
    )
  
clust_col_order <- names(top100path[,onco_res@column_order])
path_row_order <- rownames(top100path[onco_res@row_order,])

onco_ggplot <- gdc_reactome_path_analysis %>% .[rownames(.) %in% path_row_order,] %>% ## only include the top 10 paths
  rownames_to_column(var = "path_name") %>% ## path_name to col
  gather(., key = "sample_id", value = "mutation_status", -path_name) %>% ## wide to long format
  mutate(path_name = factor(.$path_name, levels = c(rev(path_row_order))), ## factor to force oncoprint order
         sample_id = factor(.$sample_id, levels = c(clust_col_order)))
save(onco_ggplot, file = "onco_ggplot.Rda")

###################
## barplot panel ##
###################

load("../data/kelly.colours.rda")
load("../data/moderate_enrich_prob.Rda")

enrich_pathways <- moderate_enrich_prob %>%
  group_by(clust) %>%
  filter(difference > 0.3 & signif <= 2500) %>%
  mutate(pathway = make_clean_names(path)) %>%
  rename(clust_knn = "clust") %>%
  select(clust_knn, pathway) %>%
  mutate(clust_knn = as.numeric(clust_knn)) %>%
  mutate(specific = TRUE)

pathway_counts <- tumor_clusters %>%
  left_join(t(gdc_reactome_path_analysis) %>% 
              as.data.frame() %>% 
              clean_names() %>% 
              rownames_to_column("sample_id")) %>% 
  group_by(clust_knn) %>%
  summarise(total = n(), across(intrinsic_pathway_for_apoptosis:signaling_by_the_b_cell_receptor_bcr, sum)) %>%
  mutate(across(intrinsic_pathway_for_apoptosis:signaling_by_the_b_cell_receptor_bcr, ~ .x / total)) %>%
  select(-total) %>%
  pivot_longer(-clust_knn, names_to = "pathway", values_to = "proportion") %>%
  group_by(clust_knn) %>%
  filter(pathway %in% enrich_pathways$pathway) %>%
  left_join(enrich_pathways %>% select(clust_knn, pathway, specific), by = c("clust_knn", "pathway"))

pathway_counts[is.na(pathway_counts$specific), ]$specific <- FALSE

pathway_mat <- pathway_counts %>%
  select(-specific) %>%
  pivot_wider(names_from = pathway, values_from = proportion) %>%
  ungroup() %>%
  select(-clust_knn) %>%
  as.matrix()

pathway_dist <- dist(t(pathway_mat))
pathway_clust <- as.hclust(rev(as.dendrogram(seriate(pathway_dist, method = "OLO_ward")[[1]])))
pathway_counts$pathway <- factor(pathway_counts$pathway, levels = colnames(pathway_mat)[pathway_clust$order])
bp.cluster.colors <- c(kelly.colours[3:12], "gray15")
names(bp.cluster.colors) <- 1:11

pathway_counts <- pathway_counts %>%
  mutate(color = case_when(specific ~ clust_knn, TRUE ~ 11)) %>%
  mutate(color = factor(color))
save(pathway_counts, bp.cluster.colors, file = "barplot_pathways_fig2b.rda")

#####################
## oncoprint panel ##
#####################
clust_col_order <- list()
path_row_order <- list()

for(n in 1:max(tumor_clusters$clust_knn)) {
  class_spec_sample_id <- tumor_clusters %>% .[,c("sample_id", "clust_knn")] %>% filter(clust_knn == n) %>% .[,.$sample_id] ## get class spec sample ids
  top10path <- gdc_reactome_path_analysis %>% .[, names(.) %in% class_spec_sample_id] %>% rowSums() %>% as.data.frame() %>% rownames_to_column(var = "path_name") %>% arrange(desc(.)) %>% .[1:10,] %>% .[, "path_name"] ## getting the top10 mutated pathways in class
  top10path <- gdc_reactome_path_analysis[top10path, class_spec_sample_id]
  top10path[top10path == "1"] <- "MUT" ## categorize boolean values
  top10path[top10path == "0"] <- " "
  col <- c("MUT" = "firebrick3")
heatmap_legend <- list(title = "", at = c("MUT"),
                       labels = c("Mutation"))
alter_fun = list(
    background = function(x, y, w, h) {
        grid.rect(x, y, w-unit(0.5, "mm"), h-unit(0.5, "mm"), 
            gp = gpar(fill = "#CCCCCC", col = NA))
    },
    # bug red
    MUT = function(x, y, w, h) {
        grid.rect(x, y, w-unit(0.5, "mm"), h-unit(0.5, "mm"), 
            gp = gpar(fill = col["MUT"], col = NA))
    })
  column_title <- "test"
  onco_res <- oncoPrint(top10path,
    alter_fun = alter_fun, col = col,
    column_title = column_title, heatmap_legend_param = heatmap_legend,
    remove_empty_columns = F, remove_empty_rows = F, right_annotation = NULL,
    top_annotation = NULL
    )
  clust_col_order[[n]] <- names(top10path[,onco_res@column_order])
  path_row_order[[n]] <- rownames(top10path[onco_res@row_order,])
}

save(clust_col_order, path_row_order, file = "onco_clust.Rda")
```

```{r figure-2-plot, fig.align= 'center', fig.height= 7, fig.width = 7}
#out.height='90%', out.width='90%'
## top100 pathways pancancer oncoprint
load("../data/onco_ggplot.Rda") ## load data
onco_color <- c("0" = "grey", "1" = "firebrick3") ## color scheme for oncoprint

fig2A <- ggplot(data = onco_ggplot, aes(x=sample_id, y=path_name)) + 
  geom_tile(aes(fill = as.character(mutation_status))) +
  scale_fill_manual(values = onco_color) +
  theme_classic() +
  xlab("Pan-Cancer (n=7,607 tumor samples)") +
  ylab("377 pathways") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        #plot.tag = element_text(size = 8, hjust = 0, vjust = 0),
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        legend.position = "none")

load("../data/effect_heatmap.Rda") ## load data
effect_colors = c("1" = "#2d004b", "2" = "#542788", "3" = "#8073ac", "4" = "#b2abd2", "5" = "#d8daeb", "6" = "white", "7" = "#fee0b6", "8" = "#fdb863", "9" = "#e08214","10" = "#b35806","11" ="#7f3b08") ## color scheme

guide_axis_label_trans <- function(label_trans = identity, ...) {
  axis_guide <- guide_axis(...)
  axis_guide$label_trans <- rlang::as_function(label_trans)
  class(axis_guide) <- c("guide_axis_trans", class(axis_guide))
  axis_guide
}

guide_train.guide_axis_trans <- function(x, ...) {
  trained <- NextMethod()
  trained$key$.label <- x$label_trans(trained$key$.label)
  trained
}

fig2B <- ggplot(data = effect_heatmap, aes(y = cluster, x = path_name)) +
  geom_tile(size = 1, aes(fill = effect_size)) +
  scale_fill_fermenter(
    type = "div",
    palette = "PuOr",
    n.breaks = 12,
    limits = c(-1, 1),
    name = "Effect Size",
    labels = c(-1, "", 0.5, "", "", 0, "", "", 0.5, "", 1)
  ) +
  facet_wrap(~cluster, ncol = 1, strip.position = "right", scales = "free_y") +
  guides(fill = guide_colorsteps(title.position = "top", title.hjust = 0.5)) +
  xlab("377 pathways, ward.D2 clustered") +
  ylab("Clusters") +
  scale_x_discrete(position = "top") +
  guides(y.sec = guide_axis_label_trans(~ paste(.x))) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    axis.ticks = element_blank(),
    strip.text.y = element_text(size = 10, hjust = .5),
    strip.text.y.right = element_text(angle = 0),
    strip.background = element_blank(),
    panel.background = element_blank(),
    panel.spacing = unit(0, "lines"),
    legend.position = "bottom",
    legend.key.height = unit(0.3, "lines"),
    legend.text = element_text(size = 5),
    legend.title = element_text(size = 5),
    legend.margin=margin(0,0,0,0),
    legend.box.margin=margin(-10,-10,0,-10)
  )

load("../data/barplot_pathways_fig2b.rda")
fig2C <- pathway_counts %>% ggplot(aes(x = pathway, y = proportion, fill = color)) +
  geom_col() +
  facet_wrap(~clust_knn, ncol = 1, strip.position = "right") +
  ylab("Proportion of mutated samples") +
  xlab("Significant pathways") +
  theme_classic() +
  scale_fill_manual(values = bp.cluster.colors) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    axis.ticks = element_blank(),
    axis.line = element_blank(),
    #strip.text.y = element_text(size = 10, hjust = .5),
    #plot.tag = element_text(size = 12, hjust = 0, vjust = 0),
    strip.text.y.right = element_text(angle = 0),
    strip.background = element_blank(),
    legend.position = "none"
  )


layout <- '
AAABBBB
AAABBBB
AAABBBB
AAACCCC
AAACCCC
AAACCCC
AAACCCC
'

fig2A + fig2B + fig2C + plot_layout(design = layout) + plot_annotation(tag_levels = "A")
```