```{r}
library(data.table)
library(ggplot2)
library(tidyverse)
library(kableExtra)
```


### Supplementary Figure S1
```{r supplementary-figure-s1, out.width = '90%', fig.align='center'}
umap_cancertype <- fread("../data/umap_3d_coors.tsv") ## load data

umap_bg <- umap_cancertype[,-"project_code"] ## get background data for facet
  
ggplot(umap_cancertype, aes(x = plot_y, y = plot_x, colour = project_code)) + 
  geom_point(data = umap_bg, aes(x = plot_y, y = plot_x), colour = "grey", size = 0.25) +
  geom_point(size = 0.25) +
  theme_classic() +
  coord_fixed() +
  xlab("UMAP 1") + ylab("UMAP 2") +
  scale_colour_manual(values = rep("firebrick3", 23)) +
  theme(axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks = element_blank(),
    axis.line = element_blank(),
    legend.position = "none") +
  facet_wrap(~ project_code, ncol = 5) ## facet by cancer_type
```
![**Supplementary figure S1. Distribution of cancer type on UMAP clusters.** Each panel shows the identity of individual tumors by one of 23 cancer types projected onto the cluster UMAP identified in **Figure 1 A** of the main text._]

### Supplementary Figure S2

```{r supplementary-figure-s2-data-generation, out.width = '90%', fig.align = "center"}
umap_cancertype <- fread("../data/umap_3d_coors.tsv") ## load data
umap_bg <- umap_cancertype[,-"project_code"] ## get background data for facet

ggplot(umap_cancertype, aes(x = plot_y, y = plot_x, colour = Subtype_Selected)) + 
  geom_point(data = umap_bg, aes(x = plot_y, y = plot_x), colour = "grey", size = 0.25) +
  geom_point(size = 0.25) +
  theme_classic() +
  coord_fixed() +
  xlab("UMAP 1") + ylab("UMAP 2") +
  theme(axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks = element_blank(),
    axis.line = element_blank(),
    legend.position = "none") +
  facet_wrap(~ project_code, ncol = 5) ## facet by cancer type
```

![**Supplementary Figure S2. Histological subtypes.** _Each panel shows the histological subtypes of one of the 23 cancers projected on to the tumors of the UMAP from **Figure 1A of the main text.**_]

### Supplementary Figure S3

<div style="text-align: right"> Supplementary Figure S3 Data </div>
```{r supplementary-figure-s3-data-generation, eval = FALSE}
load("../data/gdc_tumor_coding_complete.Rdata")
load("../data/gene_data.Rda")

## Booleanize mutation count for each tumor sample
missense <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$missense) 
splice <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$splice)
frameshdel <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$frameshdel)
frameshins <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$frameshins)
utr3 <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$utr3)
utr5 <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$utr5)
nonstop <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$nonstop)
nonsense <- as.data.frame(SummarizedExperiment::assays(gdc_tumor_coding_complete)$nonsense)

gdc_mut_count_patient <- missense + splice + frameshdel + frameshins + utr3 + utr5 + nonstop + nonsense ## add up all the mutation count
rm(missense, splice, frameshdel, frameshins, utr3, utr5, nonstop, nonsense)
gc()
gdc_mut_count_patient[gdc_mut_count_patient > 0] <- 1 ## booleanize data, anything greater than 1 is equal to 1

## MMR genes
genes <- c("MSH2", "MSH6", "MLH1", "MLH3", "PMS1", "PMS2", "BRIP1", "RAD51", "CHEK2", "APC",
           "TET2", "TET3", "TERT", "TEP1", "DKC1")

selected_mut <- gene_data %>% dplyr::select(external_gene_name, ensembl_gene_id) %>% filter(external_gene_name %in% genes) ## getting ensembl_id for the mmr genes for filtering gdc data

# ##oncogene
# oncogene <- c("AKT2","BCL2","CTNNB1","ERBB2","KRAS","MDM2","MYC","PIK3CA","TET2","USP6") ## list of selected oncogene
# ##tumor_supressor
# tumor_suppressor <- c("APC","BRIP1","CDKN2C","CHEK2","MSH2","PTEN","RB1","SMARCA4","TP53","VHL", "APOBEC3B") ## list of selected tumor suppressor
# 
# selected_mut <- gene_data %>% dplyr::select(external_gene_name, ensembl_gene_id) %>% filter(external_gene_name %in% c(oncogene, tumor_suppressor)) ## getting ensembl_id for the oncogenes for filtering gdc data

selected_mut <- gdc_mut_count_patient %>% filter(rownames(.) %in% selected_mut$ensembl_gene_id) %>% ## filter by ensembl ids
  rownames_to_column(var = "ensembl_gene_id") %>% left_join(., selected_mut, by = "ensembl_gene_id") %>% ## replace ensembl ids with gene name 
  column_to_rownames(var = "external_gene_name") %>% dplyr::select(-ensembl_gene_id) %>%
  t() %>% as.data.frame() %>% rownames_to_column(var = "sample_id")  ## prep for left_join


selected_mut <- umap_cancertype %>% dplyr::select(sample_id, plot_x, plot_y) %>% ## select relevant columns
  left_join(., selected_mut, by = "sample_id") %>%
  melt(data = ., id.vars = c("sample_id", "plot_x", "plot_y")) %>%
  filter(value != 0)

save(selected_mut, file = "../data/selected_mut.Rda")
```

```{r supplementary-figure-s3, out.width='77%', fig.align = "center"}
load("../data/selected_mut.Rda")
umap_cancertype <- fread("../data/umap_3d_coors.tsv") ## load data
umap_bg <- umap_cancertype[,-"project_code"] ## get background data for facet

ggplot(selected_mut, aes(x = plot_y, y = plot_x, colour = as.character(value))) + 
  geom_point(data = umap_bg, aes(x = plot_y, y = plot_x), colour = "grey", size = 0.25) +
  geom_point(size = 0.25) +
  theme_classic() +
  coord_fixed() +
  xlab("UMAP 1") + ylab("UMAP 2") +
  scale_colour_manual(values = rep("firebrick3", 20)) +
  theme(axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks = element_blank(),
    axis.line = element_blank(),
    legend.position = "none") +
  facet_wrap(~ factor(variable, levels = c("MSH2", "MSH6", "MLH1", "MLH3", "PMS1", "PMS2", "BRIP1", "RAD51", "CHEK2", "APC", "TET2", "TET3", "TERT", "TEP1", "DKC1")), ncol = 5) ## facet by gene
```

![**Supplementary Figure S3. Common oncogenic mutations.** _Each panel shows one of 20 commonly mutated oncogenic genes projected on the UMAP from **Figure 1A of the main text.**_]

### Supplementary Figure S4

<div style="text-align: right"> Supplementary Figure S4 Data </div>
```{r supplementary-figure-s4-data-generation, eval = FALSE}
load("../data/gdc_reactome_path_analysis.Rda") ## load data
umap_cancertype <- fread("../data/umap_3d_coors.tsv") 
n_path <- 377 ## how many pathways do we want to look at starting from the most to least mutated pathway

toppath <- gdc_reactome_path_analysis %>% rowSums() %>% as.data.frame() %>% rownames_to_column(var = "path_name") %>% arrange(desc(.)) %>% .[1:n_path,] %>% .[, "path_name"] ## order pathway by most to least mutated pathway

selected_path <- gdc_reactome_path_analysis %>% t() %>% as.data.frame() %>% rownames_to_column(var = "sample_id") ## prepare pathway for left_join

selected_path <- umap_cancertype %>% dplyr::select(sample_id, plot_x, plot_y) %>% ## select relevant columns
  left_join(., selected_path, by = "sample_id") %>%
  melt(data = ., id.vars = c("sample_id", "plot_x", "plot_y")) %>%
  filter(value != 0)

save(selected_path, file = "../data/selected_path.Rda")

load("../data/selected_path.Rda") ## load data
load("../data/gdc_reactome_path_analysis.Rda")
umap_cancertype <- fread("../data/umap_3d_coors.tsv")
umap_bg <- umap_cancertype[,-"project_code"] ## get background data for facet

n_path <- 377 ## number of pathways we want to see

toppath <- gdc_reactome_path_analysis %>% rowSums() %>% as.data.frame() %>% rownames_to_column(var = "path_name") %>% arrange(desc(.)) %>% .[1:n_path,] %>% .[, "path_name"] ## order pathway by most to least mutated pathway.. needed for facet

## creating layout to plot all 377 pathways
figs4_layout <- data.frame(start = seq(from = 1, to = length(toppath), by = 25),
                          end = c(seq(from = 25, to = length(toppath), by = 25), length(toppath)))

for(n in 1:nrow(figs4_layout)) {
  message(n)
  pathway_layout <- figs4_layout %>% .[n,] ## getting the layout for selecting pathways
  pathway_layout <- toppath[pathway_layout$start:pathway_layout$end] ## filtering those pathways from toppath
  filtered_path <- selected_path %>% filter(variable %in% pathway_layout) %>% ## filtering our data to only include those pathways
    mutate(variable = factor(variable, levels = c(pathway_layout)))
  ggplot_umap <- ggplot(filtered_path, aes(x = plot_y, y = plot_x, colour = as.character(value))) + 
    geom_point(data = umap_bg, aes(x = plot_y, y = plot_x), colour = "grey", size = 0.25) +
    geom_point(size = 0.25) +
    theme_classic() +
    coord_fixed() +
    xlab("UMAP 1") + ylab("UMAP 2") +
    scale_colour_manual(values = rep("firebrick3", 25)) +
    theme(axis.text.x = element_blank(),
      axis.text.y = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      axis.ticks = element_blank(),
      axis.line = element_blank(),
      strip.text = element_text(size = 5),
      legend.position = "none") +
    facet_wrap(~ variable,
               ncol = 5) ## facet by pathways
  new_dfname <- paste0("ggplot_umap_", n)
  assign(paste0(new_dfname), value = ggplot_umap)
}

save(ggplot_umap_1,ggplot_umap_2,ggplot_umap_3,ggplot_umap_4,ggplot_umap_5,ggplot_umap_6,ggplot_umap_7,ggplot_umap_8,ggplot_umap_9,ggplot_umap_10,ggplot_umap_11,ggplot_umap_12,ggplot_umap_13,ggplot_umap_14,ggplot_umap_15,ggplot_umap_16, file = "../data/fig_s4_ggplot.Rda")
```

```{r supplementary-figure-s4, message = FALSE, echo = FALSE, out.width = '90%', fig.align= 'center'}
load("../data/fig_s4_ggplot.Rda")

ggplot_umap_1
ggplot_umap_2
ggplot_umap_3
ggplot_umap_4
ggplot_umap_5
ggplot_umap_6
ggplot_umap_7
ggplot_umap_8
ggplot_umap_9
ggplot_umap_10
ggplot_umap_11
ggplot_umap_12
ggplot_umap_13
ggplot_umap_14
ggplot_umap_15
ggplot_umap_16

# ggplot(selected_path, aes(x = x_2d, y = y_2d, colour = as.character(value))) + 
#   geom_point(data = umap_bg, aes(x = x_2d, y = y_2d), colour = "grey", size = 0.5) +
#   geom_point(size = 0.5) +
#   theme_classic() +
#   coord_fixed() +
#   xlab("UMAP 1") + ylab("UMAP 2") +
#   scale_colour_manual(values = rep("firebrick3", 20)) +
#   theme(axis.text.x = element_blank(),
#     axis.text.y = element_blank(),
#     axis.title.x = element_blank(),
#     axis.title.y = element_blank(),
#     axis.ticks = element_blank(),
#     axis.line = element_blank(),
#     legend.position = "none") +
#   facet_wrap(~ factor(variable, levels = toppath),
#                       ncol = 5) ## facet by pathways

```

![**Supplementary Figure S4. Projection of pathway disruptions onto the UMAP.**_]

### Supplementary Table ST1

<div style="text-align: right"> Supplementary Figure ST1 Data </div>
```{r supplemental-table-st1-data-generation, eval = FALSE}
load("../data/gdc_tumor_coding_complete.Rdata")
load("../data/gdc_reactome_path_analysis.Rda")
load("../data/gene2_level2_lookup.Rda")
load("../data/pathname2level2.Rda")
load("../data/gene_data.Rda")
load("../data/gdc_gene_exp_adj.Rda")

## Parameters ##
n_path <- 377 ## how many top pathways do you want to see. 1 = top path, 2 = top path and second most
mutated_gene_position <- c(1,2,3) ## what gene do you want to see. 1 = top gene, 2 = second most, 3 = third
show_perc <- TRUE ## show perc for mutated gene


toppath <- gdc_reactome_path_analysis %>% rowSums() %>% as.data.frame() %>% rownames_to_column(var = "path_name") %>% arrange(desc(.)) %>% .[1:n_path,] %>% .[, "path_name"] ## getting the top mutated pathways

id_to_names <- gene2level2_lookup %>% rownames_to_column(var = "ensembl_gene_id") %>% ## convert ensembl to gene name
  left_join(., gene_data[,c("ensembl_gene_id", "external_gene_name")], by = "ensembl_gene_id") %>%
  remove_rownames() %>% column_to_rownames(var = "external_gene_name") %>%
  dplyr::select(-ensembl_gene_id) %>%
  t() %>% as.data.frame() %>% rownames_to_column(var = "PATH_ID") %>% ## convert path_id to path_name
  left_join(., pathname2level2, by = "PATH_ID") %>%
  remove_rownames() %>% column_to_rownames(var = "PATH_NAME") %>%
  dplyr::select(-PATH_ID) %>%
  t() %>% as.data.frame()

gene_mutation <- gdc_gene_exp_adj %>% rownames_to_column(var = "ensembl_gene_id") %>% ## convert ensembl to gene name
  left_join(., gene_data[,c("ensembl_gene_id", "external_gene_name")], by = "ensembl_gene_id") %>%
  remove_rownames() %>% column_to_rownames(var = "external_gene_name") %>%
  dplyr::select(-ensembl_gene_id)

table_st1 <- list() ## list for forloop 

for(n in toppath) {
  message(n)
  ## finding top mutated gene in pathway
  gene_in_path <- id_to_names %>% .[,which(names(.) == n)] %>% as.data.frame() %>% ## select pathway
    'rownames<-' (rownames(id_to_names)) %>% 
    filter(. == 1) %>% ## filter for genes that are in that pathway
    rownames(.)
  top_mut_gene <- gene_mutation %>% .[rownames(.) %in% gene_in_path, ] %>% ## only include genes in paths
      rowSums() %>% as.data.frame() %>% 'colnames<-' ("obs_count") %>% ## sum the pathway mutation
    rownames_to_column(var = "gene") %>%
      mutate(n_sample = length(gene_mutation),
             perc_mut = round((obs_count / length(gene_mutation)) * 100, digits = 1)) %>% 
       arrange(desc(obs_count))
  top_gene_in_path <- list()
  for(p in mutated_gene_position) {
    message(p)
    if(show_perc == TRUE) {
    top_gene_in_path[[p]] <- paste0(top_mut_gene$gene[p], " (", top_mut_gene$perc_mut[p],"%)")  
    }
    if(show_perc == FALSE) {
    top_gene_in_path[[p]] <- paste0(top_mut_gene$gene[p])  
    }
  }
  top_gene_in_path <- top_gene_in_path %>% do.call(rbind, .) %>% as.data.frame() %>% ## rbind list
   'rownames<-' (mutated_gene_position) %>% t() %>% as.data.frame()
  ## calculating the percent mutated samples
  spec_path <- data.frame(Pathway = n,
                          Percent_Mutated = round(gdc_reactome_path_analysis %>% .[n,] %>% sum() / length(gdc_reactome_path_analysis) * 100, digits = 1))
  table_st1[[n]] <- cbind(spec_path, top_gene_in_path)
}
table_st1 <- as.data.frame(do.call(rbind, table_st1))
save(table_st1, file = "../data/table_st1.Rda")  
rm(list = ls(all.names = T))  
gc()
```

```{r supplemental-table-st1}
load("../data/table_st1.Rda")

table_st1 %>% dplyr::select(-Pathway) %>% knitr::kable(format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE, font_size = 12) %>%
  column_spec(1, bold = T, color = "black")
```

![**Supplementary Table ST1. Frequency of pathway disruption and top genes within pathways.** _A complete list of pathway disruptions with percent mutatied samples and top genes_]


![**Supplemental figure S6. Survival fit independent of disease status.** _The red and blue curves show the survival of people in the US by female and male, respectively. The orange and green curves show the model fits._](../figures/fig6A.png)