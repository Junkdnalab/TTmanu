```{r sankey-plot}
umap_cancertype <- fread("../data/umap_3d_coors.tsv") ## load data
load("../data/kelly.colours.rda")
load("../data/ditto.colours.rda")

sankey.data <- umap_cancertype %>% dplyr::select(sample_id, project_code, clust_knn) %>% ## select relevant columns
  gather(., key = "type", value = "value", -sample_id) ## wide to long format

## Cancer names in alphabetical order
cancerorder <- unique(umap_cancertype$project_code)
cancerorder <- cancerorder[order(cancerorder)]
## Cluster in numerical order
clustorder <- unique(umap_cancertype$clust_knn)
clustorder <- as.character(clustorder[order(clustorder)])

## Factor to force ordering
sankey.data$type <- factor(sankey.data$type, levels = c( "clust_knn", "project_code"))
sankey.data$value <- factor(sankey.data$value, levels= c(cancerorder, clustorder))

## Color scheme for sankey plot
sankey.colours <- c(ditto_colours[2:24],kelly.colours[3:12])
names(sankey.colours) <- c(cancerorder, clustorder)

## Sankey plot
ggplot(sankey.data,
       aes(x = type, stratum = value, alluvium = sample_id,
           fill = value, label = value)) +
  scale_fill_manual(values = sankey.colours) +
  geom_flow(stat = "alluvium", lode.guidance = "frontback") +
  geom_stratum(alpha = 0.5) +
  geom_text(stat = "stratum", size = 3) +
  theme_classic() +
  xlab(label = "") +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 10),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.line.x = element_blank(),
        axis.line.y = element_blank()) +
  scale_x_discrete(labels= c("Cluster", "Cancer Type"))
```


```{r figure-4-plot, fig.width = 9}
### Figure A - Cancer Type
par(mfrow = c(2,3), mai = c(0.1, 0.1, 0.1, 0.1)) ## plot layout 2x3
par(mar = c(2,2,0,0)) ## setting plot margins for the following plots

selectedcancer <- c("BRCA", "COAD", "HNSC", "PAAD") ## selecting the 4 cancer types we're interested in
A_colors <- c('#fb9a99', '#b15928', '#6a3d9a', 'springgreen4') ## Color scheme for cancer type
names(A_colors) <- selectedcancer ## Assigning cancertype a color

with(umap_cancertype %>% 
       mutate(A_color = case_when(project_code %in% selectedcancer ~ project_code, ## Create a new col named A color
                                  TRUE ~ "Other")) %>% ## Convert all cancer type that isn't the selected cancers to "Other"
       filter(A_color != "Other"), ## Remove "Other" type
     scatter3D(plot_y, -plot_z, plot_x, 
               bg = A_colors[A_color], pch = 21, cex = 0.8, lwd = 0.2,
               theta = 0, phi = 65, scale = F,
               xlab = "", ylab = "UMAP 3", zlab = "UMAP 1",
               colvar = NULL))
## Axis labels
legend("top", inset = c(0), legend=rev(names(A_colors[1:2])), col=rev(A_colors[1:2]), pch = 20, bty = "n", horiz = T, cex = 1.2)
legend("top", inset = c(0.10), legend=rev(names(A_colors[3:4])), col=rev(A_colors[3:4]), pch = 20, bty = "n", horiz = T, cex = 1.2)
title(xlab="UMAP 2", line=0)
mtext("A", side=3, line=-2.05, cex=1.2, adj=0)

### Figure B - BRCA subtype
brca_subtype <- umap_cancertype %>% filter(project_code == "BRCA") %>% ## Filter for selected cancer type
  dplyr::select(plot_x, plot_y, plot_z, Subtype_Selected) ## Select relevant column 
brca_subtype[is.na(brca_subtype)] <- "NA" ## Convert NA to character "NA"
  
## Color scheme for subtype
B_name <- unique(brca_subtype$Subtype_Selected) ## What are the subtype names
B_name <- B_name[order(B_name,na.last=T)] ## Order the names ABC and have NA last
B_color <- ditto_colours[c(2:(length(B_name) + 1))] ## Selecting enough colors from ditto
names(B_color) <- B_name ## Assigning subtypes to color

with(brca_subtype,
     scatter3D(plot_y, -plot_z, plot_x, 
               bg = B_color, pch = 21, cex = 0.8, lwd = 0.2,
               theta = 0, phi = 65, scale = F,
               xlab = "", ylab = "UMAP 3", zlab = "UMAP 1",
               colvar = NULL))
## Axis labels
legend("top", inset = c(0), legend=names(B_color[1:2]), col=B_color[1:2], pch = 20, bty = "n", horiz = T, cex = 1.2)
legend("top", inset = c(0.10), legend=names(B_color[3:4]), col=B_color[3:4], pch = 20, bty = "n", horiz = T, cex = 1.2)
legend("top", inset = c(0.20), legend=names(B_color[5:6]), col=B_color[5:6], pch = 20, bty = "n", horiz = T, cex = 1.2)
title(xlab="UMAP 2", line=0)
mtext("B", side=3, line=-2.05, cex=1.2, adj=0)

### Figure C - BRCA Somatic Mutations
load("../data/gdc_gene_exp_adj.Rda")
load("../data/gene_data.Rda")
brca <- gene_data %>% .[.$external_gene_name %in% c("BRCA1", "BRCA2"),] %>% dplyr::select(ensembl_gene_id, external_gene_name) ## Getting BRCA gene information
brca <- gdc_gene_exp_adj %>% .[rownames(.) %in% brca$ensembl_gene_id, ] %>% ## Include BRCA gene
  rownames_to_column(var = "ensembl_gene_id") %>% ## Move ensembl id to column
  left_join(., brca, by = "ensembl_gene_id") %>% ## left join with brca df 
  remove_rownames()  %>% column_to_rownames(var = "external_gene_name") %>% ## replace row with gene symbol
  dplyr::select(-ensembl_gene_id) %>% ## get rid of ensembl_id col
  t() %>% as.data.frame() %>% ## correct orientation for umap_cancertype df
  rownames_to_column(var = "sample_id") %>% ## getting data ready for leftjoin 
  mutate(BRCA1 = case_when(BRCA1 == "1" ~ "BRCA1", ## Convert booleans to categorical variables
                           BRCA1 == "0" ~ "NA"),
         BRCA2 = case_when(BRCA2 == "1" ~ "BRCA2",
                           BRCA2 == "0" ~ "NA")) %>%
  mutate(mut_type = gsub('NA,|,NA', '', paste(.$BRCA1, .$BRCA2, sep = ","))) %>% ## combine mutation cause some patients can have both
  dplyr::select(-BRCA1, -BRCA2) %>% ## remove col we don't need
  left_join(., umap_cancertype[,c("sample_id", "plot_x", "plot_y", "plot_z", "project_code")], by = "sample_id") ## leftjoin by sample id

C_colors <- c('#33a02c', '#e31a1c', '#ff7f00') ## Color scheme 
names(C_colors) <- c("BRCA1", "BRCA2", "BRCA1,BRCA2") ## Assigning mutation type to color
with(brca %>% filter(mut_type != "NA"), ## Filter samples that do not have a mutation in BRCA1 or BRCA2
     scatter3D(plot_y, -plot_z, plot_x, 
               bg = C_colors, pch = 21, cex = 0.8, lwd = 0.2,
               theta = 0, phi = 65, scale = F,
               xlab = "", ylab = "UMAP 3", zlab = "UMAP 1",
               colvar = NULL))
## Axis labels
legend("top", inset = c(0), legend=names(C_colors[c(1:2)]), col=C_colors[c(1:2)], pch = 20, bty = "n", horiz = T, cex = 1.2)
legend("top", inset = c(0.10), legend=names(C_colors[c(3)]), col=C_colors[3], pch = 20, bty = "n", horiz = T, cex = 1.2)
title(xlab="UMAP 2", line=0)
mtext("C", side=3, line=-2.05, cex=1.2, adj=0)

### Figure D - Stage
D_colors <- c('darkgoldenrod3','dodgerblue3','yellow3','tomato2') ## Color scheme
names(D_colors) <- c("Stage I", "Stage II", "Stage III", "Stage IV") ## Assign stage to color
with(umap_cancertype %>% filter(ajcc_pathologic_tumor_stage != "Not Available"), ## Filter samples that do not have stage info
     scatter3D(plot_y, -plot_z, plot_x, 
               bg = D_colors, pch = 21, cex = 0.8, lwd = 0.2,
               theta = 0, phi = 65, scale = F,
               xlab = "", ylab = "UMAP 3", zlab = "UMAP 1",
               colvar = NULL))
## Axis labels
legend("top", inset = c(0), legend=names(D_colors[1:2]), col=D_colors[1:2], pch = 20, bty = "n", horiz = T, cex = 1.2)
legend("top", inset = c(0.10), legend=names(D_colors[3:4]), col=D_colors[3:4], pch = 20, bty = "n", horiz = T, cex = 1.2)
title(xlab="UMAP 2", line=0)
mtext("D", side=3, line=-2.05, cex=1.2, adj=0)

### Figure E - Metastasis
E_colors <- c('#a6cee3','#1f78b4') ## Color scheme
names(E_colors) <- c("M0", "M1") ## Assign metastasis to color
with(umap_cancertype %>% filter(ajcc_metastasis_pathologic_pm %in% c("M0", "M1")), ## Only M0 and M1 tumor samples
     scatter3D(plot_y, -plot_z, plot_x, 
               bg = E_colors, pch = 21, cex = 0.8, lwd = 0.2,
               theta = 0, phi = 65, scale = F,
               xlab = "", ylab = "UMAP 3", zlab = "UMAP 1",
               colvar = NULL))
## Axis labels
legend("top", inset = c(0), legend=names(E_colors), col=E_colors, pch = 20, bty = "n", horiz = T, cex = 1.2)
title(xlab="UMAP 2", line=0)
mtext("E", side=3, line=-2.05, cex=1.2, adj=0)

plot.new()
```


